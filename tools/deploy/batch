#!/bin/sh
#
# batch -- create multiple containers in one script
#
# usage:
#
# E.x.:
# 1.
#    users="a b c d e f g" peruser=3 labs="linux-0.11-lab cs630-qemu-lab" \
#          host="myhost" cleanup=1 security=0 tools/deploy/batch
# 2.
#    prompt="" loop=2 interval=20 alive=20 cleanup=1 labs="linux-0.11-lab cs630-qemu-lab" tools/deploy/batch
#

TOP_DIR=$(cd $(dirname $0)/../../ && pwd)
. $TOP_DIR/tools/docker/config $* >/dev/null 2>&1

[ -z "$users" ] && users="ubuntu"
[ -z "$peruser" ] && peruser=1
[ -z "$labs" ] && labs=linux-0.11-lab
[ -z "$cleanup" ] && cleanup=0
[ -z "$security" ] && security=2
[ -z "$host" ] && host=$HOST
[ -z "$alive" ] && alive=""
[ -z "$interval" ] && interval=""
[ -z "$loop" ] && loop=1
[ -z "$prompt" ] && prompt='<p>Hello, Cloud Lab!</p>'

LAB_SECURITY=$security

. ${TOP_DIR}/tools/deploy/init


echo "LOG: Start batch running"

for i in `seq 1 $loop`
do
  echo "LOG: Current Count: $i"

  for lab in $labs
  do
    echo "LOG: Choose $lab"
    PULL=0 ${TOP_DIR}/tools/docker/choose $lab

    if [ $cleanup -eq 1 ]; then
      echo "LOG: Clean up $lab"
      yes yes | ${TOP_DIR}/tools/deploy/clean $lab
      echo $lab > $LAB_CURRENT
    fi

    echo "LOG: Unlock $lab"
    ${TOP_DIR}/tools/docker/unlock $lab

    echo $host > ${TOP_DIR}/.host_name

    for user in $users
    do
      echo "LOG: Run $lab for $user"
      export RELEASE=1 && lab_alive=$alive ${TOP_DIR}/tools/deploy/run $lab $user $peruser &
    done
  done

  echo "LOG: Release all labs"
  for i in `seq 1 5`
  do
    sleep 2
    lab_life=$alive prompt="$prompt" ${TOP_DIR}/tools/deploy/release all >/dev/null
  done

  if [ -n "$alive" ]; then
    echo "LOG: Allow $lab running for ${alive}."
    alive_seconds=`time_to_seconds $alive`
    for i in `seq 1 5 $alive_seconds`
    do
      sleep 5
      echo "LOG: Check alive $i of $alive_seconds"
      lab_life=$alive prompt="$prompt" ${TOP_DIR}/tools/deploy/release all >/dev/null
    done

    export NOTIFY_WAIT=30
    export NOTIFY_MSG="Lab will be removed"

    for lab in $labs
    do
      echo "LOG: Clean up $lab"
      (yes yes | ${TOP_DIR}/tools/deploy/clean $lab) &
    done

    sleep $NOTIFY_WAIT

    unset NOTIFY_WAIT
    unset NOTIFY_MSG

    echo "LOG: Empty release page" && prompt="$prompt" get_labs
    sleep 10
  fi

  if [ -n "$interval" -a $i -ne $loop ]; then
    echo "LOG: sleep for ${interval}."
    sleep `time_to_seconds $interval`
  fi

done
